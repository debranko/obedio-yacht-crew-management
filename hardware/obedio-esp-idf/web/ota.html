<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBEDIO - OTA Update</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .nav {
            display: flex;
            background: #f7f7f7;
            border-bottom: 1px solid #e0e0e0;
        }
        .nav a {
            flex: 1;
            padding: 15px;
            text-align: center;
            text-decoration: none;
            color: #666;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav a:hover {
            background: #e0e0e0;
        }
        .nav a.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }
        .content {
            padding: 30px;
        }
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .warning-box h3 {
            color: #856404;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .warning-box p {
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }
        .warning-icon {
            font-size: 24px;
        }
        .upload-area {
            border: 3px dashed #e0e0e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f7f7f7;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .upload-area.drag-over {
            border-color: #667eea;
            background: #e8edff;
            transform: scale(1.02);
        }
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .upload-area h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .upload-area p {
            color: #666;
            font-size: 14px;
        }
        .file-info {
            background: #f7f7f7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .file-info.visible {
            display: block;
        }
        .file-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .file-info-row:last-child {
            margin-bottom: 0;
        }
        .file-info-row span:first-child {
            color: #666;
        }
        .file-info-row span:last-child {
            color: #333;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        .progress-container {
            margin-bottom: 20px;
            display: none;
        }
        .progress-container.visible {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            font-weight: 600;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .message {
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
            font-size: 14px;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OBEDIO Smart Button</h1>
            <p>Firmware Update (OTA)</p>
        </div>

        <div class="nav">
            <a href="/">Config</a>
            <a href="/debug">Debug</a>
            <a href="/status">Status</a>
            <a href="/ota" class="active">OTA</a>
        </div>

        <div class="content">
            <div class="warning-box">
                <h3>
                    <span class="warning-icon">‚ö†Ô∏è</span>
                    Important Notice
                </h3>
                <p>
                    Firmware updates will restart the device. Ensure the device has stable power
                    and WiFi connection. Do not power off during the update process. Only upload
                    valid firmware (.bin) files built for this device.
                </p>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Select Firmware File</h3>
                <p>Click to browse or drag & drop a .bin file</p>
            </div>

            <input type="file" id="fileInput" accept=".bin">

            <div class="file-info" id="fileInfo">
                <div class="file-info-row">
                    <span>File Name:</span>
                    <span id="fileName">-</span>
                </div>
                <div class="file-info-row">
                    <span>File Size:</span>
                    <span id="fileSize">-</span>
                </div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>

            <button class="btn btn-primary" id="uploadBtn" disabled>Upload Firmware</button>

            <div class="message" id="message"></div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const uploadBtn = document.getElementById('uploadBtn');
        const message = document.getElementById('message');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        // Click to browse
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // File selected
        fileInput.addEventListener('change', (e) => {
            handleFileSelect(e.target.files[0]);
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFileSelect(e.dataTransfer.files[0]);
        });

        function handleFileSelect(file) {
            if (!file) return;

            // Validate file extension
            if (!file.name.endsWith('.bin')) {
                showMessage('error', 'Please select a valid firmware file (.bin)');
                return;
            }

            selectedFile = file;

            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatBytes(file.size);
            fileInfo.classList.add('visible');
            uploadBtn.disabled = false;

            message.style.display = 'none';
            progressContainer.classList.remove('visible');
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function showMessage(type, text) {
            message.className = 'message ' + type;
            message.textContent = text;
            message.style.display = 'block';
        }

        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            if (!confirm('Are you sure you want to update the firmware? The device will restart after the update.')) {
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="loading"></span>Uploading...';
            message.style.display = 'none';
            progressContainer.classList.add('visible');

            try {
                const xhr = new XMLHttpRequest();

                // Track upload progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressFill.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }
                });

                // Handle completion
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            showMessage('success', response.message || 'Firmware uploaded successfully! Device is rebooting...');

                            // Disable further uploads
                            uploadBtn.innerHTML = 'Update Complete - Device Rebooting';

                            // Show reconnection message after delay
                            setTimeout(() => {
                                showMessage('success', 'Device should be back online shortly. Please refresh the page.');
                            }, 5000);
                        } catch (e) {
                            showMessage('success', 'Firmware uploaded successfully! Device is rebooting...');
                        }
                    } else {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            showMessage('error', 'Upload failed: ' + (response.message || 'Unknown error'));
                        } catch (e) {
                            showMessage('error', 'Upload failed with status: ' + xhr.status);
                        }
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = 'Upload Firmware';
                    }
                });

                // Handle errors
                xhr.addEventListener('error', () => {
                    showMessage('error', 'Upload failed. Please check your connection and try again.');
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = 'Upload Firmware';
                });

                // Send request
                xhr.open('POST', '/api/ota');
                xhr.send(selectedFile);

            } catch (error) {
                showMessage('error', 'Upload failed: ' + error.message);
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'Upload Firmware';
            }
        });
    </script>
</body>
</html>
