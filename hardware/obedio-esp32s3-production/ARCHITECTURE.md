# OBEDIO ESP32-S3 Smart Button - System Architecture

Complete system architecture and data flow documentation.

---

## ğŸ—ï¸ System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OBEDIO SMART BUTTON SYSTEM                   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   ESP32-S3   â”‚â—„â”€â”€â”€â”€â–ºâ”‚ MQTT Broker  â”‚â—„â”€â”€â”€â”€â–ºâ”‚   Backend    â”‚ â”‚
â”‚  â”‚ Smart Button â”‚ WiFi â”‚  Mosquitto   â”‚ MQTT â”‚   Node.js    â”‚ â”‚
â”‚  â”‚   (Device)   â”‚      â”‚ 10.10.0.207  â”‚      â”‚  API Server  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                            â”‚         â”‚
â”‚    [Buttons]                                  [Web Dashboard]  â”‚
â”‚    [Sensors]                                  [Smart Watches]  â”‚
â”‚    [LED Ring]                                 [Notifications]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¡ Communication Flow

### Device â†’ Backend (Button Press)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User      â”‚
â”‚  Presses    â”‚  Physical
â”‚   Button    â”‚  Action
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESP32-S3 Hardware Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ MCP23017 GPIO Expander (I2C 0x20)    â”‚   â”‚
â”‚  â”‚ - Detects button press (active LOW)  â”‚   â”‚
â”‚  â”‚ - Port A Pin reads 0 (pressed)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                            â”‚
â”‚                 â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Button Handler (Arduino Code)        â”‚   â”‚
â”‚  â”‚ - Debounce (50ms)                    â”‚   â”‚
â”‚  â”‚ - Detect press type:                 â”‚   â”‚
â”‚  â”‚   â€¢ Single click (<700ms)            â”‚   â”‚
â”‚  â”‚   â€¢ Double click (2x <500ms)         â”‚   â”‚
â”‚  â”‚   â€¢ Long press (â‰¥700ms)              â”‚   â”‚
â”‚  â”‚ - Identify button (T1-T6)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MQTT Publish Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Build JSON Payload:                  â”‚   â”‚
â”‚  â”‚ {                                    â”‚   â”‚
â”‚  â”‚   "deviceId": "BTN-D4CA6E112233",   â”‚   â”‚
â”‚  â”‚   "button": "main",                  â”‚   â”‚
â”‚  â”‚   "pressType": "single",             â”‚   â”‚
â”‚  â”‚   "timestamp": 1234567890,           â”‚   â”‚
â”‚  â”‚   "battery": 85,                     â”‚   â”‚
â”‚  â”‚   "rssi": -45,                       â”‚   â”‚
â”‚  â”‚   "firmwareVersion": "v1.0",         â”‚   â”‚
â”‚  â”‚   "sequenceNumber": 1234             â”‚   â”‚
â”‚  â”‚ }                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                            â”‚
â”‚  Topic: obedio/button/{deviceId}/press      â”‚
â”‚  QoS: 1 (at least once delivery)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼ WiFi (10.10.0.207:1883)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MQTT Broker (Mosquitto)                    â”‚
â”‚  - Receives message                         â”‚
â”‚  - Routes to all subscribers                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend MQTT Service (Node.js)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ mqtt.service.ts                      â”‚   â”‚
â”‚  â”‚ - Subscribes to all button topics    â”‚   â”‚
â”‚  â”‚ - Parses JSON payload                â”‚   â”‚
â”‚  â”‚ - Validates device ID                â”‚   â”‚
â”‚  â”‚ - Extracts button & press type       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service Request Handler                    â”‚
â”‚  - Create new service request in database   â”‚
â”‚  - Determine request type from button       â”‚
â”‚  - Assign to location/guest                 â”‚
â”‚  - Notify crew via WebSocket                â”‚
â”‚  - Send push notification to smart watch    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Bidirectional Communication

### Backend â†’ Device (Remote Commands)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web Dashboard  â”‚
â”‚  Admin sends    â”‚
â”‚  LED command    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend API (Node.js)                      â”‚
â”‚  POST /api/devices/{id}/test                â”‚
â”‚  { "command": "led", "color": "green" }     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MQTT Publish (Backend)                     â”‚
â”‚  Topic: obedio/device/{deviceId}/command    â”‚
â”‚  Payload: {"command":"led","color":"green"} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ MQTT Broker
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESP32-S3 (Subscribed to command topic)     â”‚
â”‚  - Receives MQTT message                    â”‚
â”‚  - Parses JSON                              â”‚
â”‚  - Executes command:                        â”‚
â”‚    â€¢ LED: Change color                      â”‚
â”‚    â€¢ Reboot: ESP.restart()                  â”‚
â”‚    â€¢ Status: Send telemetry                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ–¥ï¸ Hardware Architecture (ESP32-S3 PCB)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ESP32-S3R8 MODULE                        â”‚
â”‚                         (Main Controller)                         â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  CPU: Dual-core Xtensa LX7 @ 240MHz                        â”‚ â”‚
â”‚  â”‚  RAM: 512KB SRAM + 8MB PSRAM                               â”‚ â”‚
â”‚  â”‚  Flash: 8MB (GD25Q128ESIG)                                 â”‚ â”‚
â”‚  â”‚  WiFi: 2.4GHz 802.11 b/g/n                                 â”‚ â”‚
â”‚  â”‚  Bluetooth: BLE 5.0 (not used)                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  GPIO Interfaces:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   I2C    â”‚   I2S    â”‚   SPI    â”‚  GPIO    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚          â”‚          â”‚          â”‚
        â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ I2C Bus   â”‚ â”‚  I2S   â”‚ â”‚  SPI   â”‚ â”‚ Direct   â”‚
â”‚ (3V3)     â”‚ â”‚ Audio  â”‚ â”‚ Flash  â”‚ â”‚   GPIO   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚            â”‚          â”‚           â”‚
      â”‚            â”‚          â”‚           â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PERIPHERAL LAYER                        â”‚
â”‚                                                   â”‚
â”‚  I2C Devices (GPIO2=SCL, GPIO3=SDA):              â”‚
â”‚  â”œâ”€ MCP23017 (0x20) - GPIO Expander (Buttons)    â”‚
â”‚  â”œâ”€ LIS3DH (0x19) - 3-Axis Accelerometer         â”‚
â”‚  â””â”€ MCP9808 (0x18) - Temperature Sensor          â”‚
â”‚                                                   â”‚
â”‚  I2S Audio:                                       â”‚
â”‚  â”œâ”€ Microphone (MSM261S4030H0R)                  â”‚
â”‚  â”‚  â”œâ”€ BCLK: GPIO33                              â”‚
â”‚  â”‚  â”œâ”€ WS: GPIO38                                â”‚
â”‚  â”‚  â””â”€ SD: GPIO34                                â”‚
â”‚  â”‚                                                â”‚
â”‚  â””â”€ Speaker/Amp (MAX98357A)                      â”‚
â”‚     â”œâ”€ BCLK: GPIO10                              â”‚
â”‚     â”œâ”€ WS: GPIO18                                â”‚
â”‚     â”œâ”€ SD: GPIO11                                â”‚
â”‚     â””â”€ SD_MODE: GPIO14                           â”‚
â”‚                                                   â”‚
â”‚  Direct GPIO:                                     â”‚
â”‚  â””â”€ LED Ring: GPIO17 (WS2812B x16)               â”‚
â”‚                                                   â”‚
â”‚  SPI (Internal):                                  â”‚
â”‚  â””â”€ Flash Memory: 8MB (firmware storage)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”˜ Button Processing State Machine

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚     IDLE     â”‚
                  â”‚ (Monitoring) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    Button Press
                    Detected (LOW)
                          â”‚
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  DEBOUNCE    â”‚
                  â”‚   (50ms)     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    Still Pressed?
                          â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚               â”‚
                 NO              YES
                  â”‚               â”‚
                  â–¼               â–¼
            [Ignore]      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            Noise         â”‚   PRESSED    â”‚
                          â”‚ Send "press" â”‚
                          â”‚  Start timer â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                        Wait for release
                        Monitor duration
                                  â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚               â”‚
                    < 700ms          â‰¥ 700ms
                          â”‚               â”‚
                          â–¼               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚SHORT RELEASE â”‚ â”‚  LONG PRESS  â”‚
                  â”‚ Check double â”‚ â”‚Send "long"   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚               â”‚
                    Last click           â”‚
                    < 500ms?             â”‚
                          â”‚               â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”      â”‚
                  â”‚               â”‚      â”‚
                 NO              YES     â”‚
                  â”‚               â”‚      â”‚
                  â–¼               â–¼      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚SINGLE CLICK  â”‚ â”‚DOUBLE CLICK  â”‚
          â”‚Send "single" â”‚ â”‚Send "double" â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    LED Feedback
                    Update State
                          â”‚
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚     IDLE     â”‚
                  â”‚ (Monitoring) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Data Flow - Complete Path

### 1. Device Boot Sequence

```
Power On
   â”‚
   â–¼
ESP32-S3 Boot
   â”‚
   â”œâ”€ Load firmware from flash
   â”œâ”€ Initialize serial (115200)
   â”œâ”€ Print startup banner
   â”œâ”€ Generate Device ID from MAC
   â”‚
   â–¼
Initialize Hardware
   â”‚
   â”œâ”€ I2C Bus (GPIO2/3)
   â”œâ”€ MCP23017 (buttons)
   â”œâ”€ LED Ring (GPIO17)
   â”œâ”€ Accelerometer (optional)
   â”œâ”€ Temperature (optional)
   â”‚
   â–¼
Connect to WiFi
   â”‚
   â”œâ”€ SSID: "Obedio"
   â”œâ”€ Password: "BrankomeinBruder:)"
   â”œâ”€ Timeout: 20 seconds
   â”œâ”€ Retry: 10 attempts
   â”‚
   â–¼
Connect to MQTT
   â”‚
   â”œâ”€ Broker: 10.10.0.207:1883
   â”œâ”€ Client ID: obedio-button-{timestamp}
   â”œâ”€ Subscribe: obedio/device/{deviceId}/command
   â”œâ”€ Subscribe: obedio/device/{deviceId}/registered
   â”‚
   â–¼
Register Device
   â”‚
   â”œâ”€ Publish to: obedio/device/register
   â”œâ”€ Send capabilities & info
   â”‚
   â–¼
Start Main Loop
   â”‚
   â”œâ”€ Monitor buttons
   â”œâ”€ Send heartbeat (30s)
   â”œâ”€ Send telemetry (60s)
   â”œâ”€ Handle MQTT messages
   â””â”€ Check reconnections
```

### 2. Button Event Processing

```
Button Press
   â”‚
   â–¼
Hardware Detection (MCP23017)
   â”‚
   â”œâ”€ Read GPIO state via I2C
   â”œâ”€ Detect LOW (pressed) state
   â”‚
   â–¼
Debounce Logic (50ms)
   â”‚
   â”œâ”€ Wait for stable state
   â”œâ”€ Ignore noise
   â”‚
   â–¼
Press Type Detection
   â”‚
   â”œâ”€ Start press timer
   â”œâ”€ Send immediate "press" event
   â”‚
   â–¼
Wait for Release
   â”‚
   â”œâ”€ Monitor duration
   â”œâ”€ Send "long" if â‰¥700ms
   â”‚
   â–¼
Analyze Click Pattern
   â”‚
   â”œâ”€ Single: <700ms, no follow-up
   â”œâ”€ Double: 2x clicks <500ms apart
   â”œâ”€ Long: Held â‰¥700ms
   â”‚
   â–¼
Create JSON Payload
   â”‚
   â”œâ”€ Device ID
   â”œâ”€ Button name (main/aux1-5)
   â”œâ”€ Press type
   â”œâ”€ Timestamp
   â”œâ”€ Battery level
   â”œâ”€ WiFi RSSI
   â”œâ”€ Sequence number
   â”‚
   â–¼
Publish to MQTT
   â”‚
   â”œâ”€ Topic: obedio/button/{deviceId}/press
   â”œâ”€ QoS: 1
   â”œâ”€ Retain: false
   â”‚
   â–¼
Visual Feedback
   â”‚
   â”œâ”€ LED ring color change
   â”œâ”€ Animation based on press type
   â”‚
   â–¼
Return to Monitoring
```

### 3. Heartbeat & Telemetry

```
Timer Triggered (30s/60s)
   â”‚
   â–¼
Collect System Data
   â”‚
   â”œâ”€ Uptime (millis() / 1000)
   â”œâ”€ Free heap memory
   â”œâ”€ WiFi RSSI
   â”œâ”€ Battery level (ADC)
   â”œâ”€ IP address
   â”œâ”€ MAC address
   â”‚
   â–¼
Build JSON Payload
   â”‚
   â”œâ”€ Heartbeat: Minimal data
   â”œâ”€ Telemetry: Full system status
   â”‚
   â–¼
Publish to MQTT
   â”‚
   â”œâ”€ Heartbeat: obedio/device/heartbeat
   â”œâ”€ Telemetry: obedio/device/{deviceId}/telemetry
   â”‚
   â–¼
Backend Processing
   â”‚
   â”œâ”€ Update device status
   â”œâ”€ Check health metrics
   â”œâ”€ Alert if offline >5min
   â”‚
   â–¼
Return to Main Loop
```

---

## ğŸŒ Network Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOCAL NETWORK (10.10.0.x)               â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Router     â”‚    â”‚  MQTT Broker â”‚    â”‚   Backend   â”‚ â”‚
â”‚  â”‚  10.10.0.1   â”‚â—„â”€â”€â–ºâ”‚  Mosquitto   â”‚â—„â”€â”€â–ºâ”‚   Node.js   â”‚ â”‚
â”‚  â”‚   Gateway    â”‚    â”‚ 10.10.0.207  â”‚    â”‚10.10.0.207  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚  Port: 1883  â”‚    â”‚  Port: 8080 â”‚ â”‚
â”‚          â”‚           â”‚  (WebSocket  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚           â”‚   Port: 9001)â”‚                    â”‚
â”‚          â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚          â”‚                  â–²                            â”‚
â”‚          â”‚                  â”‚ MQTT Protocol              â”‚
â”‚          â”‚                  â”‚ (pub/sub)                  â”‚
â”‚          â–¼                  â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚         WiFi Connected Devices               â”‚        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚        â”‚
â”‚  â”‚  â”‚  ESP32-S3    â”‚  â”‚  ESP32-S3    â”‚          â”‚        â”‚
â”‚  â”‚  â”‚   Button 1   â”‚  â”‚   Button 2   â”‚  ... N   â”‚        â”‚
â”‚  â”‚  â”‚10.10.0.123   â”‚  â”‚10.10.0.124   â”‚          â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Memory Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ESP32-S3 Memory Map (8MB Flash)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0x0000   - 0x9000   â”‚  Bootloader                  â”‚
â”‚  0x9000   - 0xE000   â”‚  NVS (Non-Volatile Storage)  â”‚
â”‚  0xE000   - 0x10000  â”‚  OTA Data                    â”‚
â”‚  0x10000  - 0x310000 â”‚  App Partition 0 (3MB)       â”‚
â”‚  0x310000 - 0x610000 â”‚  App Partition 1 (3MB)       â”‚
â”‚  0x610000 - 0x790000 â”‚  SPIFFS (1.5MB)              â”‚
â”‚  0x790000 - 0x7A0000 â”‚  Coredump (64KB)             â”‚
â”‚  0x7A0000 - 0x800000 â”‚  Reserved                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Runtime Memory (SRAM + PSRAM):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Heap:        ~150KB used / 512KB SRAM              â”‚
â”‚  Stack:       ~8KB per task                         â”‚
â”‚  WiFi/BT:     ~70KB reserved                        â”‚
â”‚  PSRAM:       8MB available (for future features)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Current Security Status                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WiFi:        WPA2-PSK                                â”‚
â”‚  MQTT:        No authentication (development)         â”‚
â”‚  Encryption:  None (plaintext)                        â”‚
â”‚  Firmware:    No signing/encryption                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Production Security Recommendations         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WiFi:        WPA3-SAE                                â”‚
â”‚  MQTT:        TLS 1.3 + Client certificates           â”‚
â”‚  Encryption:  AES-256 for message payloads            â”‚
â”‚  Firmware:    Signed OTA updates                      â”‚
â”‚  Auth:        Username/password + API keys            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Scalability

The architecture supports:

| Metric | Current | Maximum |
|--------|---------|---------|
| Devices per Network | 1-10 | 254 |
| MQTT Messages/sec | ~3 | 1000+ |
| Concurrent Connections | 10 | 100+ |
| Button Events/min | ~60 | Unlimited |
| Network Latency | <100ms | <500ms |
| Heartbeat Interval | 30s | Configurable |

---

**Document Version:** 1.0
**Last Updated:** 2025-01-17
**Architecture:** ESP32-S3 + MQTT + Node.js Backend
