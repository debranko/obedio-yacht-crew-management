generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ActivityLog {
  id         String    @id
  action     String
  details    String?
  userId     String?
  locationId String?
  guestId    String?
  deviceId   String?
  metadata   String?
  timestamp  DateTime  @default(now())
  createdAt  DateTime  @default(now())
  type       String?   @default("info")
  Device     Device?   @relation(fields: [deviceId], references: [id])
  Guest      Guest?    @relation(fields: [guestId], references: [id])
  Location   Location? @relation(fields: [locationId], references: [id])
  User       User?     @relation(fields: [userId], references: [id])
}

model Assignment {
  id           String     @id
  date         String
  shiftId      String
  crewMemberId String
  type         String
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  CrewMember   CrewMember @relation(fields: [crewMemberId], references: [id], onDelete: Cascade)
  Shift        Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([date, shiftId, crewMemberId, type])
  @@index([crewMemberId])
  @@index([date])
  @@index([shiftId])
  @@index([type])
}

model CrewChangeLog {
  id           String   @id
  crewMemberId String
  changeType   String
  fieldName    String
  oldValue     String?
  newValue     String
  changedBy    String?
  reason       String?
  createdAt    DateTime @default(now())

  @@index([changeType])
  @@index([createdAt])
  @@index([crewMemberId])
}

model CrewMember {
  id               String             @id
  name             String
  position         String
  department       String
  status           String
  contact          String?
  email            String?
  joinDate         DateTime?
  role             String?
  userId           String?            @unique
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  avatar           String?
  color            String             @default("#C8A96B")
  languages        String[]           @default([])
  leaveEnd         String?
  leaveStart       String?
  nickname         String?
  notes            String?
  onBoardContact   String?
  phone            String?
  skills           String[]           @default([])
  Assignment       Assignment[]
  User             User?              @relation(fields: [userId], references: [id])
  Device           Device[]
  DeviceAssignment DeviceAssignment[]
  ServiceRequest   ServiceRequest[]

  @@index([department])
  @@index([status])
  @@index([userId])
}

model Device {
  id               String             @id
  deviceId         String             @unique
  name             String
  type             String
  subType          String?
  status           DeviceStatus       @default(online)
  locationId       String?
  crewMemberId     String?
  batteryLevel     Int?
  signalStrength   Int?
  connectionType   String?
  lastSeen         DateTime?
  config           Json?
  firmwareVersion  String?
  hardwareVersion  String?
  macAddress       String?
  ipAddress        String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  ActivityLog      ActivityLog[]
  CrewMember       CrewMember?        @relation(fields: [crewMemberId], references: [id])
  Location         Location?          @relation(fields: [locationId], references: [id])
  DeviceAssignment DeviceAssignment[]
  DeviceLog        DeviceLog[]

  @@index([crewMemberId])
  @@index([lastSeen])
  @@index([locationId])
  @@index([status])
  @@index([type])
}

model DeviceAssignment {
  id           String     @id
  deviceId     String
  crewMemberId String
  assignedAt   DateTime   @default(now())
  notes        String?
  CrewMember   CrewMember @relation(fields: [crewMemberId], references: [id])
  Device       Device     @relation(fields: [deviceId], references: [id])

  @@unique([deviceId, crewMemberId])
}

model DeviceLog {
  id        String   @id
  deviceId  String
  eventType String
  eventData Json?
  severity  String   @default("info")
  createdAt DateTime @default(now())
  Device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([deviceId])
  @@index([eventType])
}

model Guest {
  id                       String           @id
  firstName                String
  lastName                 String
  preferredName            String?
  photo                    String?
  type                     GuestType        @default(guest)
  status                   GuestStatus      @default(onboard)
  nationality              String?
  languages                String[]         @default([])
  passportNumber           String?
  locationId               String?
  cabin                    String?
  doNotDisturb             Boolean          @default(false)
  checkInDate              DateTime?
  checkInTime              String?
  checkOutDate             DateTime?
  checkOutTime             String?
  specialOccasion          String?
  specialOccasionDate      DateTime?
  allergies                String[]         @default([])
  dietaryRestrictions      String[]         @default([])
  medicalConditions        String[]         @default([])
  foodDislikes             String[]         @default([])
  favoriteFoods            String[]         @default([])
  favoriteDrinks           String[]         @default([])
  preferences              String?
  notes                    String?
  specialRequests          String?
  vipNotes                 String?
  crewNotes                String?
  contactPerson            Json?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  email                    String?
  phone                    String?
  createdBy                String?
  createdAt                DateTime         @default(now())
  updatedAt                DateTime
  ActivityLog              ActivityLog[]
  Location                 Location?        @relation(fields: [locationId], references: [id])
  ServiceRequest           ServiceRequest[]

  @@index([checkInDate])
  @@index([checkOutDate])
  @@index([locationId])
  @@index([status])
  @@index([type])
}

model Location {
  id             String           @id
  name           String           @unique
  type           String
  floor          String?
  description    String?
  image          String?
  smartButtonId  String?          @unique
  doNotDisturb   Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  ActivityLog    ActivityLog[]
  Device         Device[]
  Guest          Guest[]
  ServiceRequest ServiceRequest[]
}

model Message {
  id                            String          @id
  senderId                      String
  receiverId                    String?
  content                       String
  type                          MessageType     @default(text)
  priority                      MessagePriority @default(normal)
  isRead                        Boolean         @default(false)
  readAt                        DateTime?
  createdAt                     DateTime        @default(now())
  User_Message_receiverIdToUser User?           @relation("Message_receiverIdToUser", fields: [receiverId], references: [id])
  User_Message_senderIdToUser   User            @relation("Message_senderIdToUser", fields: [senderId], references: [id])

  @@index([createdAt])
  @@index([receiverId])
  @@index([senderId])
}

model NotificationSettings {
  id                String   @id
  userId            String   @unique
  pushEnabled       Boolean  @default(true)
  pushToken         String?
  serviceRequests   Boolean  @default(true)
  emergencyAlerts   Boolean  @default(true)
  systemMessages    Boolean  @default(true)
  guestMessages     Boolean  @default(true)
  crewMessages      Boolean  @default(true)
  quietHoursEnabled Boolean  @default(false)
  quietHoursStart   String?
  quietHoursEnd     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RolePermissions {
  id          String   @id
  role        String   @unique
  permissions Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model ServiceCategory {
  id             String           @id
  name           String           @unique
  icon           String           @default("tag")
  color          String           @default("gray")
  description    String?
  order          Int              @default(0)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  ServiceRequest ServiceRequest[]
}

model ServiceRequest {
  id              String                 @id
  requestType     ServiceRequestType     @default(call)
  guestId         String?
  locationId      String?
  cabinId         String?
  categoryId      String?
  priority        ServiceRequestPriority @default(normal)
  notes           String?
  voiceTranscript String?
  assignedTo      String?
  assignedToId    String?
  guestName       String?
  guestCabin      String?
  acceptedAt      DateTime?
  completedAt     DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime
  status          String?                @default("pending")
  CrewMember      CrewMember?            @relation(fields: [assignedToId], references: [id])
  ServiceCategory ServiceCategory?       @relation(fields: [categoryId], references: [id])
  Guest           Guest?                 @relation(fields: [guestId], references: [id])
  Location        Location?              @relation(fields: [locationId], references: [id])

  @@index([assignedToId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([guestId])
  @@index([locationId])
  @@index([priority])
}

model ServiceRequestHistory {
  id                String                  @id
  serviceRequestId  String?
  originalRequestId String?
  action            String
  notes             String?
  userId            String?
  metadata          Json?
  completedBy       String?
  completedAt       DateTime?
  responseTime      Int?
  completionTime    Int?
  guestName         String?
  location          String?
  requestType       ServiceRequestType?
  priority          ServiceRequestPriority?
  createdAt         DateTime                @default(now())
  newStatus         String?                 @default("pending")

  @@index([createdAt])
  @@index([originalRequestId])
  @@index([serviceRequestId])
}

model Shift {
  id           String       @id
  name         String
  startTime    String
  endTime      String
  color        String       @default("#3B82F6")
  description  String?
  isActive     Boolean      @default(true)
  order        Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  backupCount  Int          @default(1)
  primaryCount Int          @default(2)
  Assignment   Assignment[]

  @@index([isActive])
}

model User {
  id                               String                @id
  username                         String                @unique
  email                            String                @unique
  password                         String
  firstName                        String?
  lastName                         String?
  isActive                         Boolean               @default(true)
  lastLogin                        DateTime?
  createdAt                        DateTime              @default(now())
  updatedAt                        DateTime
  role                             String?               @default("crew")
  ActivityLog                      ActivityLog[]
  CrewMember                       CrewMember?
  Message_Message_receiverIdToUser Message[]             @relation("Message_receiverIdToUser")
  Message_Message_senderIdToUser   Message[]             @relation("Message_senderIdToUser")
  NotificationSettings             NotificationSettings?
  UserPreferences                  UserPreferences?
}

model UserPreferences {
  id                               String   @id
  userId                           String   @unique
  dashboardLayout                  Json?
  activeWidgets                    Json?
  theme                            String   @default("light")
  language                         String   @default("en")
  emailNotifications               Boolean  @default(false)
  notificationEmail                String?
  emergencyContacts                Json?
  serviceRequestDisplayMode        String?  @default("location")
  serviceRequestViewStyle          String?  @default("expanded")
  serviceRequestSortOrder          String?  @default("newest")
  serviceRequestShowGuestPhotos    Boolean  @default(true)
  serviceRequestServingTimeout     Int      @default(5)
  serviceRequestSoundAlerts        Boolean  @default(true)
  serviceRequestVisualFlash        Boolean  @default(false)
  serviceRequestResponseWarning    Int      @default(5)
  serviceRequestAutoArchive        Int      @default(30)
  serviceRequestAutoPriorityVIP    Boolean  @default(true)
  serviceRequestAutoPriorityMaster Boolean  @default(false)
  requestDialogRepeatInterval      Int      @default(60)
  createdAt                        DateTime @default(now())
  updatedAt                        DateTime
  User                             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model YachtSettings {
  id                    String    @id
  name                  String    @default("Serenity")
  type                  String    @default("motor")
  timezone              String    @default("Europe/Monaco")
  floors                String[]  @default(["Lower Deck", "Main Deck", "Upper Deck", "Sun Deck"])
  dateFormat            String    @default("DD/MM/YYYY")
  timeFormat            String    @default("24h")
  weatherUnits          String    @default("metric")
  windSpeedUnits        String    @default("knots")
  weatherUpdateInterval Int       @default(30)
  latitude              Float?
  longitude             Float?
  accuracy              Float?
  locationName          String?
  locationUpdatedAt     DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  manualLatitude        Float?
  manualLongitude       Float?
  temperatureUnit       String    @default("celsius")
  useManualLocation     Boolean   @default(false)
  weatherProvider       String    @default("open-meteo")
  windyOverlay          String    @default("wind")
  windyWeatherModel     String    @default("ecmwf")
  windyZoom             Int       @default(8)
}

enum DeviceStatus {
  online
  offline
  low_battery
  error
}

enum GuestStatus {
  expected
  onboard
  ashore
  departed
}

enum GuestType {
  owner
  vip
  guest
  partner
  family
}

enum MessagePriority {
  low
  normal
  high
  urgent
}

enum MessageType {
  text
  alert
  announcement
}

enum ServiceRequestPriority {
  low
  normal
  urgent
  emergency
}

enum ServiceRequestType {
  call
  service
  emergency
  voice
  dnd
  lights
  prepare_food
  bring_drinks
}
