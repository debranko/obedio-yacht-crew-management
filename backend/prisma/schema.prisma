generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String                @id @default(cuid())
  username         String                @unique
  email            String                @unique
  password         String
  firstName        String?
  lastName         String?
  isActive         Boolean               @default(true)
  lastLogin        DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  role             String?               @default("crew")
  activitylogs     ActivityLog[]
  crewmember       CrewMember?
  receivedmessages Message[]             @relation("MessageReceiver")
  messages         Message[]             @relation("MessageSender")
  notifications    NotificationSettings?
  preferences      UserPreferences?
}

model UserPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  dashboardLayout     Json?
  activeWidgets       Json?
  theme               String   @default("light")
  language            String   @default("en")

  // Notification preferences
  emailNotifications  Boolean  @default(false)
  notificationEmail   String?
  emergencyContacts   Json?    // Array of emergency contact strings

  // Service Requests preferences
  serviceRequestDisplayMode       String?  @default("location")  // 'guest-name' or 'location'
  serviceRequestViewStyle         String?  @default("expanded")  // 'expanded' or 'compact'
  serviceRequestSortOrder         String?  @default("newest")    // 'newest', 'priority', or 'location'
  serviceRequestShowGuestPhotos   Boolean  @default(true)
  serviceRequestServingTimeout    Int      @default(5)           // Minutes
  serviceRequestSoundAlerts       Boolean  @default(true)
  serviceRequestVisualFlash       Boolean  @default(false)
  serviceRequestResponseWarning   Int      @default(5)           // Minutes
  serviceRequestAutoArchive       Int      @default(30)          // Minutes
  serviceRequestAutoPriorityVIP   Boolean  @default(true)
  serviceRequestAutoPriorityMaster Boolean @default(false)
  requestDialogRepeatInterval     Int      @default(60)          // Seconds

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CrewMember {
  id                String             @id @default(cuid())
  name              String
  position          String
  department        String
  status            String
  contact           String?
  email             String?
  joinDate          DateTime?
  role              String?
  userId            String?            @unique
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  avatar            String?
  color             String             @default("#C8A96B")
  languages         String[]           @default([])
  leaveEnd          String?
  leaveStart        String?
  nickname          String?
  notes             String?
  onBoardContact    String?
  phone             String?
  skills            String[]           @default([])
  assignments       Assignment[]
  user              User?              @relation(fields: [userId], references: [id])
  devices           Device[]
  deviceassignments DeviceAssignment[]
  servicerequests   ServiceRequest[]

  @@index([userId])
  @@index([department])
  @@index([status])
}

model Location {
  id              String           @id @default(cuid())
  name            String           @unique
  type            String
  floor           String?
  description     String?
  image           String?
  smartButtonId   String?          @unique
  doNotDisturb    Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  activitylogs    ActivityLog[]
  devices         Device[]
  guests          Guest[]
  servicerequests ServiceRequest[]
}

model Guest {
  id                       String           @id @default(cuid())
  firstName                String
  lastName                 String
  preferredName            String?
  photo                    String?
  type                     GuestType        @default(guest)
  status                   GuestStatus      @default(onboard)
  nationality              String?
  languages                String[]         @default([])
  passportNumber           String?
  locationId               String?
  cabin                    String?          // Legacy cabin field (deprecated, use locationId)
  doNotDisturb             Boolean          @default(false)

  // Accommodation & Check-in Info
  checkInDate              DateTime?
  checkInTime              String?          // HH:mm format
  checkOutDate             DateTime?
  checkOutTime             String?          // HH:mm format

  // Special Occasions
  specialOccasion          String?          // Birthday, Anniversary, etc.
  specialOccasionDate      DateTime?        // Date of the occasion

  // Dietary & Medical
  allergies                String[]         @default([])
  dietaryRestrictions      String[]         @default([])
  medicalConditions        String[]         @default([])
  foodDislikes             String[]         @default([])
  favoriteFoods            String[]         @default([])
  favoriteDrinks           String[]         @default([])

  // Preferences & Notes (categorized)
  preferences              String?          // General preferences
  notes                    String?          // Staff notes
  specialRequests          String?          // Special requests from guest
  vipNotes                 String?          // VIP-specific notes
  crewNotes                String?          // Internal crew notes

  // Contact Person (Family Office, Manager, Agent)
  contactPerson            Json?            // {name, phone, email, role}

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  // Guest Contact Info
  email                    String?
  phone                    String?

  // Metadata
  createdBy                String?          // User ID who created this guest
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt

  activitylogs             ActivityLog[]
  location                 Location?        @relation(fields: [locationId], references: [id])
  servicerequests          ServiceRequest[]

  @@index([locationId])
  @@index([status])
  @@index([type])
  @@index([checkInDate])
  @@index([checkOutDate])
}

model ServiceRequestHistory {
  id                String                  @id @default(cuid())
  serviceRequestId  String?
  originalRequestId String?
  action            String
  notes             String?
  userId            String?
  metadata          Json?
  completedBy       String?
  completedAt       DateTime?
  responseTime      Int?
  completionTime    Int?
  guestName         String?
  location          String?
  requestType       ServiceRequestType?
  priority          ServiceRequestPriority?
  createdAt         DateTime                @default(now())
  newStatus         String?                 @default("pending")

  @@index([serviceRequestId])
  @@index([originalRequestId])
  @@index([createdAt])
}

model ServiceRequest {
  id              String                 @id @default(cuid())
  requestType     ServiceRequestType     @default(call)
  guestId         String?
  locationId      String?
  cabinId         String?
  categoryId      String?
  priority        ServiceRequestPriority @default(normal)
  notes           String?
  voiceTranscript String?
  assignedTo      String?
  assignedToId    String?
  guestName       String?
  guestCabin      String?
  acceptedAt      DateTime?
  completedAt     DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  status          String?                @default("pending")
  crewmember      CrewMember?            @relation(fields: [assignedToId], references: [id])
  category        ServiceCategory?       @relation(fields: [categoryId], references: [id])
  guest           Guest?                 @relation(fields: [guestId], references: [id])
  location        Location?              @relation(fields: [locationId], references: [id])

  @@index([guestId])
  @@index([locationId])
  @@index([categoryId])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
}

model ServiceCategory {
  id          String           @id @default(cuid())
  name        String           @unique
  icon        String           @default("tag")
  color       String           @default("gray")
  description String?
  order       Int              @default(0)
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  requests    ServiceRequest[]
}

model Device {
  id              String             @id @default(cuid())
  deviceId        String             @unique
  name            String
  type            String
  subType         String?
  status          DeviceStatus       @default(online)
  locationId      String?
  crewMemberId    String?
  batteryLevel    Int?
  signalStrength  Int?
  connectionType  String?
  lastSeen        DateTime?
  config          Json?
  firmwareVersion String?
  hardwareVersion String?
  macAddress      String?
  ipAddress       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  activitylogs    ActivityLog[]
  crewmember      CrewMember?        @relation(fields: [crewMemberId], references: [id])
  location        Location?          @relation(fields: [locationId], references: [id])
  assignments     DeviceAssignment[]
  logs            DeviceLog[]

  @@index([locationId])
  @@index([crewMemberId])
  @@index([status])
  @@index([type])
  @@index([lastSeen])
}

model DeviceLog {
  id        String   @id @default(cuid())
  deviceId  String
  eventType String
  eventData Json?
  severity  String   @default("info")
  createdAt DateTime @default(now())
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([eventType])
  @@index([createdAt])
}

model DeviceAssignment {
  id           String     @id @default(cuid())
  deviceId     String
  crewMemberId String
  assignedAt   DateTime   @default(now())
  notes        String?
  crewmember   CrewMember @relation(fields: [crewMemberId], references: [id])
  device       Device     @relation(fields: [deviceId], references: [id])

  @@unique([deviceId, crewMemberId])
}

model Shift {
  id           String       @id @default(cuid())
  name         String
  startTime    String
  endTime      String
  color        String       @default("#3B82F6")
  description  String?
  isActive     Boolean      @default(true)
  order        Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  backupCount  Int          @default(1)
  primaryCount Int          @default(2)
  assignments  Assignment[]

  @@index([isActive])
}

model Assignment {
  id           String     @id @default(cuid())
  date         String
  shiftId      String
  crewMemberId String
  type         String
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  crewmember   CrewMember @relation(fields: [crewMemberId], references: [id], onDelete: Cascade)
  shift        Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([date, shiftId, crewMemberId, type])
  @@index([date])
  @@index([shiftId])
  @@index([crewMemberId])
  @@index([type])
}

model ActivityLog {
  id         String    @id @default(cuid())
  action     String
  details    String?
  userId     String?
  locationId String?
  guestId    String?
  deviceId   String?
  metadata   String?
  timestamp  DateTime  @default(now())
  createdAt  DateTime  @default(now())
  type       String?   @default("info")
  device     Device?   @relation(fields: [deviceId], references: [id])
  guest      Guest?    @relation(fields: [guestId], references: [id])
  location   Location? @relation(fields: [locationId], references: [id])
  user       User?     @relation(fields: [userId], references: [id])
}

model YachtSettings {
  id                String    @id @default(cuid())
  name              String    @default("Serenity")
  type              String    @default("motor")
  timezone          String    @default("Europe/Monaco")
  floors            String[]  @default(["Lower Deck", "Main Deck", "Upper Deck", "Sun Deck"])
  dateFormat        String    @default("DD/MM/YYYY")
  timeFormat        String    @default("24h")
  weatherUnits      String    @default("metric")
  windSpeedUnits    String    @default("knots")
  weatherUpdateInterval Int   @default(30)

  // GPS Location fields
  latitude          Float?
  longitude         Float?
  accuracy          Float?
  locationName      String?
  locationUpdatedAt DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Message {
  id         String          @id @default(cuid())
  senderId   String
  receiverId String?
  content    String
  type       MessageType     @default(text)
  priority   MessagePriority @default(normal)
  isRead     Boolean         @default(false)
  readAt     DateTime?
  createdAt  DateTime        @default(now())
  receiver   User?           @relation("MessageReceiver", fields: [receiverId], references: [id])
  sender     User            @relation("MessageSender", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

model NotificationSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  pushEnabled       Boolean  @default(true)
  pushToken         String?
  serviceRequests   Boolean  @default(true)
  emergencyAlerts   Boolean  @default(true)
  systemMessages    Boolean  @default(true)
  guestMessages     Boolean  @default(true)
  crewMessages      Boolean  @default(true)
  quietHoursEnabled Boolean  @default(false)
  quietHoursStart   String?
  quietHoursEnd     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CrewChangeLog {
  id           String   @id @default(cuid())
  crewMemberId String
  changeType   String
  fieldName    String
  oldValue     String?
  newValue     String
  changedBy    String?
  reason       String?
  createdAt    DateTime @default(now())

  @@index([crewMemberId])
  @@index([changeType])
  @@index([createdAt])
}

model RolePermissions {
  id          String   @id @default(cuid())
  role        String   @unique
  permissions Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum DeviceStatus {
  online
  offline
  low_battery
  error
}

enum GuestStatus {
  expected
  onboard
  ashore
  departed
}

enum GuestType {
  owner
  vip
  guest
  partner
  family
}

enum MessagePriority {
  low
  normal
  high
  urgent
}

enum MessageType {
  text
  alert
  announcement
}

enum ServiceRequestPriority {
  low
  normal
  urgent
  emergency
}

enum ServiceRequestType {
  call
  service
  emergency
  voice
  dnd
  lights
  prepare_food
  bring_drinks
}
